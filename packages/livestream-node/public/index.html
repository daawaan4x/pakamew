<!doctype html>
<html>
	<head>
		<title>ESP32-CAM Live Feed</title>
		<style>
			body {
				background: #111;
				color: white;
				text-align: center;
				font-family: sans-serif;
				margin: 0;
				padding: 20px;
			}
			#stream-box {
				width: 90%;
				max-width: 640px;
				margin: auto;
				border: 5px solid #333;
				background: #000;
			}
			img {
				width: 100%;
				height: auto;
				display: block;
			}
			button {
				padding: 15px 30px;
				font-size: 1.2rem;
				margin-top: 20px;
				cursor: pointer;
				background: #e74c3c;
				color: white;
				border: none;
			}
		</style>
	</head>
	<body>
		<h2>Live Security Feed</h2>
		<div id="stream-box">
			<img id="video-canvas" src="" alt="Connecting..." />
		</div>
		<button onclick="sendFeed()">FEED PET</button>

		<script>
			const img = document.getElementById("video-canvas");
			// this part id for logic to handle both local and Cloudflare URLs
			const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
			const ws = new WebSocket(`${protocol}//${window.location.host}/viewer`);
			ws.binaryType = "blob";

			ws.onmessage = (event) => {
				const url = URL.createObjectURL(event.data);
				const prevUrl = img.src;
				img.src = url;

				// critical thus part prevents memory leaks and browser freezing
				if (prevUrl.startsWith("blob:")) {
					URL.revokeObjectURL(prevUrl);
				}
			};

			function sendFeed() {
				ws.send("FEED");
			}
		</script>
	</body>
</html>
